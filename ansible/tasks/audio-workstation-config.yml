---
# ============================================================================
# AUDIO WORKSTATION SPECIFIC CONFIGURATION TASKS
# ============================================================================
# Tasks specific to audio mixing/mastering workstations
# Included by local-environments.yml when env_audio_workstation group is
# detected

- name: "ðŸŽµ Audio Workstation Configuration"
  ansible.builtin.debug:
    msg: "Configuring Audio Workstation: {{ inventory_hostname }}"

# Windows Audio Workstation Configuration
- name: Windows Audio Workstation Block
  when: ansible_os_family == "Windows"
  block:
    - name: Install professional audio software
      chocolatey.chocolatey.win_chocolatey:
        name: "{{ item }}"
        state: present
      loop:
        - audacity
        - reaper
        - voicemeeter-banana
        - asio4all

    - name: Configure Windows audio for professional use
      ansible.windows.win_shell: |
        # Disable Windows audio enhancements
        $audioKey = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Audio"
        New-ItemProperty -Path $audioKey -Name "DisableProtectedAudioDG" \
          -Value 1 -PropertyType DWORD -Force

        # Set audio service priority to high
        $serviceKey = "HKLM:\SYSTEM\CurrentControlSet\Services\AudioSrv"
        Set-ItemProperty -Path $serviceKey -Name "Priority" -Value 1

        # Configure MMCSS for audio
        $mmcssKey = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Audio"
        New-Item -Path $mmcssKey -Force
        Set-ItemProperty -Path $mmcssKey -Name "Affinity" -Value 0
        Set-ItemProperty -Path $mmcssKey -Name "Background Only" -Value "False"
        Set-ItemProperty -Path $mmcssKey -Name "Priority" -Value 6
        Set-ItemProperty -Path $mmcssKey -Name "Scheduling Category" -Value "Medium"
      changed_when: true

    - name: Configure ASIO buffer settings
      ansible.windows.win_copy:
        content: |
          [ASIO4ALL v2]
          BufferSize=128
          SampleRate=48000
          BitDepth=24
          Latency=Low
        dest: "C:\\Users\\{{ ansible_user }}\\AppData\\Local\\ASIO4ALL\\asio4all.ini"

    - name: Disable Windows audio exclusive mode conflicts
      ansible.windows.win_shell: |
        # Disable exclusive mode for default playback device
        $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\MMDevices\Audio\Render"
        Get-ChildItem $regPath | ForEach-Object {
          $devicePath = "$($_.PSPath)\Properties"
          Set-ItemProperty -Path $devicePath \
            -Name "{a45c254e-df1c-4efd-8020-67d146a850e0},2" \
            -Value 0 -ErrorAction SilentlyContinue
        }
      changed_when: true

    - name: Create audio workstation shortcuts
      ansible.windows.win_copy:
        content: |
          @echo off
          echo Starting Audio Workstation Environment...
          start "" "C:\Program Files\REAPER\reaper.exe"
          start "" "C:\Program Files\VB\Voicemeeter\voicemeeterpro.exe"
          echo Audio environment started!
          pause
        dest: "C:\\Users\\{{ ansible_user }}\\Desktop\\Start-Audio-Environment.bat"

# macOS Audio Workstation Configuration
- name: MacOS Audio Workstation Block
  when: ansible_os_family == "Darwin"
  block:
    - name: Install professional audio software
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      loop:
        - audacity
        - ffmpeg
        - sox
        - lame

    - name: Install macOS audio applications
      community.general.homebrew_cask:
        name: "{{ item }}"
        state: present
      loop:
        - reaper
        - blackhole-2ch

    - name: Configure Core Audio for low latency
      ansible.builtin.shell: |
        # Set audio buffer size
        sudo defaults write /Library/Preferences/Audio\ MIDI\ Setup \
          com.apple.audio.buffer-size -int 128

        # Set sample rate to 48kHz
        sudo defaults write /Library/Preferences/Audio\ MIDI\ Setup \
          com.apple.audio.sample-rate -int 48000

        # Enable aggregate device capabilities
        defaults write com.apple.audio.AudioMIDISetup \
          "aggregate device enabled" -bool true
      changed_when: true

    - name: Create BlackHole audio routing configuration
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          # Configure BlackHole for audio routing
          echo "Setting up BlackHole audio routing..."

          # This script should be run to setup multi-output device
          # with BlackHole for professional audio routing
          open -a "Audio MIDI Setup"
        dest: "~/Desktop/setup-audio-routing.sh"
        mode: '0755'

# Linux Audio Workstation Configuration
- name: Linux Audio Workstation Block
  when: ansible_os_family in ["Debian", "RedHat"]
  block:
    - name: Install JACK audio system
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      loop:
        - jackd2
        - qjackctl
        - audacity
        - ffmpeg
        - sox

    - name: Configure JACK for low-latency audio
      ansible.builtin.copy:
        content: |
          # JACK configuration for low-latency audio
          /usr/bin/jackd -R -P75 -dalsa -dhw:0 -r48000 -p128 -n2
        dest: "/etc/jack/jackdrc"
        mode: '0644'
      become: true

    - name: Add user to audio group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: audio
        append: true
      become: true

    - name: Configure real-time audio limits
      ansible.builtin.copy:
        content: |
          @audio   -  rtprio     99
          @audio   -  memlock    unlimited
          @audio   -  nice       -19
        dest: "/etc/security/limits.d/audio.conf"
        mode: '0644'
      become: true

# Audio Hardware Detection and Validation
- name: Detect audio hardware
  ansible.builtin.debug:
    msg: "Audio interfaces will be detected based on OS"

- name: Windows audio device detection
  ansible.windows.win_shell: |
    Get-WmiObject -Class Win32_SoundDevice | Select-Object Name, Status | ConvertTo-Json
  register: windows_audio_devices
  when: ansible_os_family == "Windows"
  changed_when: false

- name: MacOS audio device detection
  ansible.builtin.shell: system_profiler SPAudioDataType -json
  register: macos_audio_devices
  when: ansible_os_family == "Darwin"
  changed_when: false

- name: Linux audio device detection
  ansible.builtin.shell: |
    if command -v aplay >/dev/null 2>&1; then
      aplay -l 2>/dev/null || echo "No audio devices found"
    else
      echo "ALSA tools not installed"
    fi
  register: linux_audio_devices
  when: ansible_os_family in ["Debian", "RedHat"]
  changed_when: false

- name: Display detected audio devices
  ansible.builtin.debug:
    var: "{{ ansible_os_family | lower }}_audio_devices.stdout"
  when: ansible_os_family in ["Windows", "Darwin", "Debian", "RedHat"]

- name: Validate audio configuration
  ansible.builtin.assert:
    that:
      - ansible_processor_cores >= 2
      - ansible_memory_mb.real.total >= 4096
    fail_msg: >
      System does not meet minimum requirements for audio workstation
      (2 cores, 4GB RAM)
    success_msg: "System meets audio workstation requirements"

- name: Display audio configuration summary
  ansible.builtin.debug:
    msg:
      - "Audio workstation configuration completed"
      - "OS: {{ ansible_os_family }}"
      - "Hostname: {{ inventory_hostname }}"

- name: Windows audio test
  ansible.windows.win_shell: |
    # Test Windows audio subsystem
    Get-WmiObject -Class Win32_SoundDevice |
    Where-Object {$_.Status -eq "OK"} |
    Measure-Object |
    Select-Object -ExpandProperty Count
  register: windows_audio_test
  when: ansible_os_family == "Windows"
  changed_when: false

- name: Display Windows audio test results
  ansible.builtin.debug:
    msg: "Working audio devices: {{ windows_audio_test.stdout | trim }}"
  when: ansible_os_family == "Windows"
